saveRDS(death_model_last_30_df, "model_death_model_last_30_df")
saveRDS(death_model_post_may_df, "model_death_model_post_may_df")
print("DONE: Code Chunk#2")
}#//END Code Chunk #3: Build State Models and Death_frame
?loadRDS
?readRDS
temp_death_df <- readRDS("model_death_model_df.dat")
#### Write Data Frames to File.
#### The Project is to cumbersome to include in an RMD
saveRDS(death_model_df, "model_death_model_df.dat")
temp_death_df <- readRDS("model_death_model_df.dat")
temp_death_df
temp_death_df_last_30  <- readRDS("model_death_model_last_30_df")
#### Write Data Frames to File.
#### The Project is to cumbersome to include in an RMD
saveRDS(death_model_df, "model_death_model_df.dat")
saveRDS(death_model_last_30_df, "model_death_model_last_30_df")
{ #//BEGIN Code Chunk #3: Build State Models and Death_frame
print("Processing: Code Chunk#3")
##############################
### Build Statewide Models ###
#############################################################################
### Aggregates expensive county models into statewide California numbers. ###
#############################################################################
## Twice the error with 30 days
#confirm_predict_death_30_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\confirm_~_deaths_30"))
### Confirmed cases predicting outcomes
confirm_predict_death_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\confirm_~_deaths"))
confirm_predict_newdeath_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\confirm_~_newdeaths"))
confirm_predict_hospital_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\confirm_~_hospital"))
confirm_predict_icu_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\confirm_~_icu"))
#### Hospitalization predict outcomes
hospital_predict_icu_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\hospital_~_icu"))
hospital_predict_deaths_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\hospital_~_deaths"))
#### ICU predict death
icu_predict_deaths_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\icu_~_deaths"))
### Correlate offset with MSE. I wonder what else correlates with MSE
cor(confirm_predict_death_model_df$predict_offset,confirm_predict_death_model_df$predict_mse)
### Confirm Predicting New Deaths is a shit model. Error only increases
#confirm_predict_newdeaths_model_df   <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\confirm_~_newdeaths"))
newconfirm_predict_newsdeaths_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\newconfirm_~_newdeaths"))
newconfirm_predict_hospital_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\newconfirm_~_hospital"))
newconfirm_predict_icu_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\newconfirm_~_icu"))
hospital_predict_newdeaths_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\hospital_~_newdeaths"))
icu_predict_newdeaths_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\icu_~_newdeaths"))
### Testing to deaths model is very noisy. Can only build from aggregate state numbers have State
### Build testing Model from aggreagte state numbers
testing_predict_deaths_df <- build_rolling_lm_offset(offset_testing_df,"daily_total_deaths",15)
#########################################################
### Trim up testing to same Data length as other models
#########################################################
### Yes, it's ugly but it runs with one command.
### Basically, it's start at the row difference to the nrows in data frame
###############################################################################
testing_predict_deaths_df <- testing_predict_deaths_df[
(nrow(testing_predict_deaths_df) - nrow(confirm_predict_death_model_df) + 1):
nrow(testing_predict_deaths_df),]
######################################################################
######################################################################
######################################################################
### END Modeling #####################################################
######################################################################
######################################################################
######################################################################
##############################################################
### Build the death model.
### Death model combines actual data points with the models
####################################################################
####################################################################
### Death Model: Initialize with Testing and Confirmed/Deaths
####################################################################
death_model_df <- merge(removeCols(ca_testing_df,"daily_total_deaths"),daily_combined_df)
#######################################
### Death Model: Add Testing ~ Deaths
#######################################
### Move Testing into spearate data frame to merge with death model. Testing has a different number of row.
### merge() will correct this magically. The Date column is important, it is a reference column to knit the frames together
death_model_df <- merge(death_model_df, data.frame(
date=ca_testing_df$date,
testing_death_mse=testing_predict_deaths_df$mse,
testing_death_predict=testing_predict_deaths_df$predicted_deaths,
testing_death_offset=testing_predict_deaths_df$offset_index
))
#######################################
### Death Model: Add Confirmed ~ Deaths
#######################################
death_model_df$confirm_death_mse         <- confirm_predict_death_model_df$predict_mse
death_model_df$confirm_death_mse_rescale <- rescale_mse(confirm_predict_death_model_df$predict_mse,confirm_predict_death_model_df$predict_offset)
death_model_df$confirm_death_predict     <- confirm_predict_death_model_df$prediction
death_model_df$confirm_death_offset      <- confirm_predict_death_model_df$predict_offset
#  death_model_df$confirm_death_intercept   <- confirm_predict_death_model_df$predict_intercept
#  death_model_df$confirm_death_coefficient <- confirm_predict_death_model_df$predict_coefficient
death_model_df$confirm_newdeath_mse      <- confirm_predict_newdeath_model_df$predict_mse
death_model_df$confirm_newdeath_predict  <- confirm_predict_newdeath_model_df$prediction
death_model_df$confirm_newdeath_offset   <- confirm_predict_newdeath_model_df$predict_offset
#######################################
### Death Model: Add Confirm ~ Hospital
#######################################
death_model_df$confirm_hospital_mse         <- confirm_predict_hospital_model_df$predict_mse
death_model_df$confirm_hospital_predict     <- confirm_predict_hospital_model_df$prediction
death_model_df$confirm_hospital_offset      <- confirm_predict_hospital_model_df$predict_offset
#  death_model_df$confirm_hospital_intercept   <- confirm_predict_hospital_model_df$predict_intercept
#  death_model_df$confirm_hospital_coefficient <- confirm_predict_hospital_model_df$predict_coefficient
#######################################
### Death Model: Add confirm ~ icu
#######################################
death_model_df$confirm_icu_mse         <- confirm_predict_icu_model_df$predict_mse
death_model_df$confirm_icu_predict     <- confirm_predict_icu_model_df$prediction
death_model_df$confirm_icu_offset      <- confirm_predict_icu_model_df$predict_offset
#  death_model_df$confirm_icu_intercept   <- confirm_predict_icu_model_df$predict_intercept
#  death_model_df$confirm_icu_coefficient <- confirm_predict_icu_model_df$predict_coefficient
death_model_df$newconfirm_newdeath_mse        <- newconfirm_predict_newsdeaths_model_df$predict_mse
death_model_df$newconfirm_newdeath_prediction <- newconfirm_predict_newsdeaths_model_df$prediction
death_model_df$newconfirm_newdeath_offset     <- newconfirm_predict_newsdeaths_model_df$predict_offset
death_model_df$newconfirm_hospital_mse        <- newconfirm_predict_hospital_model_df$predict_mse
death_model_df$newconfirm_hospital_prediction <- newconfirm_predict_hospital_model_df $prediction
death_model_df$newconfirm_hospital_offset     <- newconfirm_predict_hospital_model_df$predict_offset
death_model_df$newconfirm_icu_mse        <- newconfirm_predict_icu_model_df$predict_mse
death_model_df$newconfirm_icu_prediction <- newconfirm_predict_icu_model_df$prediction
death_model_df$newconfirm_icu_offset     <- newconfirm_predict_icu_model_df$predict_offset
#######################################
### Death Model: Add hospital ~ icu
#######################################
death_model_df$hospital_icu_mse         <- hospital_predict_icu_model_df$predict_mse
death_model_df$hospital_icu_predict     <- hospital_predict_icu_model_df$prediction
death_model_df$hospital_icu_offset      <- hospital_predict_icu_model_df$predict_offset
#  death_model_df$hospital_icu_intercept   <- hospital_predict_icu_model_df$predict_intercept
#  death_model_df$hospital_icu_coefficient <- hospital_predict_icu_model_df$predict_coefficient
#######################################
### Death Model: Add hospital ~ death
#######################################
death_model_df$hospital_death_mse         <- hospital_predict_deaths_df$predict_mse
death_model_df$hospital_death_predict     <- hospital_predict_deaths_df$prediction
death_model_df$hospital_death_offset      <- hospital_predict_deaths_df$predict_offset
#  death_model_df$hospital_death_intercept   <- hospital_predict_deaths_df$predict_intercept
#  death_model_df$hospital_death_coefficient <- hospital_predict_deaths_df$predict_coefficient
death_model_df$hospital_newdeath_mse        <- hospital_predict_newdeaths_model_df$predict_mse
death_model_df$hospital_newdeath_prediction <- hospital_predict_newdeaths_model_df$prediction
death_model_df$hospital_newdeath_offset     <- hospital_predict_newdeaths_model_df$predict_offset
#######################################
### Death Model: Add icu ~ death
#######################################
death_model_df$icu_death_mse         <- icu_predict_deaths_df$predict_mse
death_model_df$icu_death_prediction  <- icu_predict_deaths_df$prediction
death_model_df$icu_death_offset      <- icu_predict_deaths_df$predict_offset
#  death_model_df$icu_death_intercept   <- icu_predict_deaths_df$predict_intercept
#  death_model_df$icu_death_coefficient <- icu_predict_deaths_df$predict_coefficient
death_model_df$icu_newdeaths_mse        <- icu_predict_newdeaths_model_df$predict_mse
death_model_df$icu_newdeaths_prediction <- icu_predict_newdeaths_model_df$prediction
death_model_df$icu_newdeaths_offset     <- icu_predict_newdeaths_model_df$predict_offset
#### Build a separate Death Model Comprising the last 30 days
death_model_last_30_df <- death_model_df[ (nrow(death_model_df)-30) : nrow(death_model_df),]
#### Build Post May Death Model
death_model_post_may_df <- death_model_df[ 36 : nrow(death_model_df),]
#### Write Data Frames to File.
#### The Project is to cumbersome to include in an RMD
saveRDS(death_model_df, "model_death_model_df.dat")
saveRDS(death_model_last_30_df, "model_death_model_last_30_df")
saveRDS(death_model_post_may_df, "model_death_model_post_may_df")
print("DONE: Code Chunk#2")
}#//END Code Chunk #3: Build State Models and Death_frame
{ #//BEGIN Code Chunk #3: Build State Models and Death_frame
print("Processing: Code Chunk#3")
##############################
### Build Statewide Models ###
#############################################################################
### Aggregates expensive county models into statewide California numbers. ###
#############################################################################
## Twice the error with 30 days
#confirm_predict_death_30_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\confirm_~_deaths_30"))
### Confirmed cases predicting outcomes
confirm_predict_death_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\confirm_~_deaths"))
confirm_predict_newdeath_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\confirm_~_newdeaths"))
confirm_predict_hospital_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\confirm_~_hospital"))
confirm_predict_icu_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\confirm_~_icu"))
#### Hospitalization predict outcomes
hospital_predict_icu_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\hospital_~_icu"))
hospital_predict_deaths_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\hospital_~_deaths"))
#### ICU predict death
icu_predict_deaths_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\icu_~_deaths"))
### Correlate offset with MSE. I wonder what else correlates with MSE
cor(confirm_predict_death_model_df$predict_offset,confirm_predict_death_model_df$predict_mse)
### Confirm Predicting New Deaths is a shit model. Error only increases
#confirm_predict_newdeaths_model_df   <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\confirm_~_newdeaths"))
newconfirm_predict_newsdeaths_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\newconfirm_~_newdeaths"))
newconfirm_predict_hospital_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\newconfirm_~_hospital"))
newconfirm_predict_icu_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\newconfirm_~_icu"))
hospital_predict_newdeaths_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\hospital_~_newdeaths"))
icu_predict_newdeaths_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\icu_~_newdeaths"))
### Testing to deaths model is very noisy. Can only build from aggregate state numbers have State
### Build testing Model from aggreagte state numbers
testing_predict_deaths_df <- build_rolling_lm_offset(offset_testing_df,"daily_total_deaths",15)
#########################################################
### Trim up testing to same Data length as other models
#########################################################
### Yes, it's ugly but it runs with one command.
### Basically, it's start at the row difference to the nrows in data frame
###############################################################################
testing_predict_deaths_df <- testing_predict_deaths_df[
(nrow(testing_predict_deaths_df) - nrow(confirm_predict_death_model_df) + 1):
nrow(testing_predict_deaths_df),]
######################################################################
######################################################################
######################################################################
### END Modeling #####################################################
######################################################################
######################################################################
######################################################################
##############################################################
### Build the death model.
### Death model combines actual data points with the models
####################################################################
####################################################################
### Death Model: Initialize with Testing and Confirmed/Deaths
####################################################################
death_model_df <- merge(removeCols(ca_testing_df,"daily_total_deaths"),daily_combined_df)
#######################################
### Death Model: Add Testing ~ Deaths
#######################################
### Move Testing into spearate data frame to merge with death model. Testing has a different number of row.
### merge() will correct this magically. The Date column is important, it is a reference column to knit the frames together
temp_testing_model <- data.frame(
date=ca_testing_df$date,
testing_death_mse=testing_predict_deaths_df$mse,
testing_death_predict=testing_predict_deaths_df$predicted_deaths,
testing_death_offset=testing_predict_deaths_df$offset_index
)
death_model_df <- merge(death_model_df, temp_testing_model)
#######################################
### Death Model: Add Confirmed ~ Deaths
#######################################
death_model_df$confirm_death_mse         <- confirm_predict_death_model_df$predict_mse
death_model_df$confirm_death_mse_rescale <- rescale_mse(confirm_predict_death_model_df$predict_mse,confirm_predict_death_model_df$predict_offset)
death_model_df$confirm_death_predict     <- confirm_predict_death_model_df$prediction
death_model_df$confirm_death_offset      <- confirm_predict_death_model_df$predict_offset
#  death_model_df$confirm_death_intercept   <- confirm_predict_death_model_df$predict_intercept
#  death_model_df$confirm_death_coefficient <- confirm_predict_death_model_df$predict_coefficient
death_model_df$confirm_newdeath_mse      <- confirm_predict_newdeath_model_df$predict_mse
death_model_df$confirm_newdeath_predict  <- confirm_predict_newdeath_model_df$prediction
death_model_df$confirm_newdeath_offset   <- confirm_predict_newdeath_model_df$predict_offset
#######################################
### Death Model: Add Confirm ~ Hospital
#######################################
death_model_df$confirm_hospital_mse         <- confirm_predict_hospital_model_df$predict_mse
death_model_df$confirm_hospital_predict     <- confirm_predict_hospital_model_df$prediction
death_model_df$confirm_hospital_offset      <- confirm_predict_hospital_model_df$predict_offset
#  death_model_df$confirm_hospital_intercept   <- confirm_predict_hospital_model_df$predict_intercept
#  death_model_df$confirm_hospital_coefficient <- confirm_predict_hospital_model_df$predict_coefficient
#######################################
### Death Model: Add confirm ~ icu
#######################################
death_model_df$confirm_icu_mse         <- confirm_predict_icu_model_df$predict_mse
death_model_df$confirm_icu_predict     <- confirm_predict_icu_model_df$prediction
death_model_df$confirm_icu_offset      <- confirm_predict_icu_model_df$predict_offset
#  death_model_df$confirm_icu_intercept   <- confirm_predict_icu_model_df$predict_intercept
#  death_model_df$confirm_icu_coefficient <- confirm_predict_icu_model_df$predict_coefficient
death_model_df$newconfirm_newdeath_mse        <- newconfirm_predict_newsdeaths_model_df$predict_mse
death_model_df$newconfirm_newdeath_prediction <- newconfirm_predict_newsdeaths_model_df$prediction
death_model_df$newconfirm_newdeath_offset     <- newconfirm_predict_newsdeaths_model_df$predict_offset
death_model_df$newconfirm_hospital_mse        <- newconfirm_predict_hospital_model_df$predict_mse
death_model_df$newconfirm_hospital_prediction <- newconfirm_predict_hospital_model_df $prediction
death_model_df$newconfirm_hospital_offset     <- newconfirm_predict_hospital_model_df$predict_offset
death_model_df$newconfirm_icu_mse        <- newconfirm_predict_icu_model_df$predict_mse
death_model_df$newconfirm_icu_prediction <- newconfirm_predict_icu_model_df$prediction
death_model_df$newconfirm_icu_offset     <- newconfirm_predict_icu_model_df$predict_offset
#######################################
### Death Model: Add hospital ~ icu
#######################################
death_model_df$hospital_icu_mse         <- hospital_predict_icu_model_df$predict_mse
death_model_df$hospital_icu_predict     <- hospital_predict_icu_model_df$prediction
death_model_df$hospital_icu_offset      <- hospital_predict_icu_model_df$predict_offset
#  death_model_df$hospital_icu_intercept   <- hospital_predict_icu_model_df$predict_intercept
#  death_model_df$hospital_icu_coefficient <- hospital_predict_icu_model_df$predict_coefficient
#######################################
### Death Model: Add hospital ~ death
#######################################
death_model_df$hospital_death_mse         <- hospital_predict_deaths_df$predict_mse
death_model_df$hospital_death_predict     <- hospital_predict_deaths_df$prediction
death_model_df$hospital_death_offset      <- hospital_predict_deaths_df$predict_offset
#  death_model_df$hospital_death_intercept   <- hospital_predict_deaths_df$predict_intercept
#  death_model_df$hospital_death_coefficient <- hospital_predict_deaths_df$predict_coefficient
death_model_df$hospital_newdeath_mse        <- hospital_predict_newdeaths_model_df$predict_mse
death_model_df$hospital_newdeath_prediction <- hospital_predict_newdeaths_model_df$prediction
death_model_df$hospital_newdeath_offset     <- hospital_predict_newdeaths_model_df$predict_offset
#######################################
### Death Model: Add icu ~ death
#######################################
death_model_df$icu_death_mse         <- icu_predict_deaths_df$predict_mse
death_model_df$icu_death_prediction  <- icu_predict_deaths_df$prediction
death_model_df$icu_death_offset      <- icu_predict_deaths_df$predict_offset
#  death_model_df$icu_death_intercept   <- icu_predict_deaths_df$predict_intercept
#  death_model_df$icu_death_coefficient <- icu_predict_deaths_df$predict_coefficient
death_model_df$icu_newdeaths_mse        <- icu_predict_newdeaths_model_df$predict_mse
death_model_df$icu_newdeaths_prediction <- icu_predict_newdeaths_model_df$prediction
death_model_df$icu_newdeaths_offset     <- icu_predict_newdeaths_model_df$predict_offset
#### Build a separate Death Model Comprising the last 30 days
death_model_last_30_df <- death_model_df[ (nrow(death_model_df)-30) : nrow(death_model_df),]
#### Build Post May Death Model
death_model_post_may_df <- death_model_df[ 36 : nrow(death_model_df),]
#### Write Data Frames to File.
#### The Project is to cumbersome to include in an RMD
saveRDS(death_model_df, "model_death_model_df.dat")
saveRDS(death_model_last_30_df, "model_death_model_last_30_df")
saveRDS(death_model_post_may_df, "model_death_model_post_may_df")
print("DONE: Code Chunk#2")
}#//END Code Chunk #3: Build State Models and Death_frame
### Testing to deaths model is very noisy. Can only build from aggregate state numbers have State
### Build testing Model from aggreagte state numbers
testing_predict_deaths_df <- build_rolling_lm_offset(offset_testing_df,"daily_total_deaths",15)
testing_predict_deaths_df <- testing_predict_deaths_df[
(nrow(testing_predict_deaths_df) - nrow(confirm_predict_death_model_df) + 1):
nrow(testing_predict_deaths_df),]
####################################################################
### Death Model: Initialize with Testing and Confirmed/Deaths
####################################################################
death_model_df <- merge(removeCols(ca_testing_df,"daily_total_deaths"),daily_combined_df)
#######################################
### Death Model: Add Testing ~ Deaths
#######################################
### Move Testing into spearate data frame to merge with death model. Testing has a different number of row.
### merge() will correct this magically. The Date column is important, it is a reference column to knit the frames together
temp_testing_model <- data.frame(
date=ca_testing_df$date,
testing_death_mse=testing_predict_deaths_df$mse,
testing_death_predict=testing_predict_deaths_df$predicted_deaths,
testing_death_offset=testing_predict_deaths_df$offset_index
)
nrow(temp_testing_model)
#######################################
### Death Model: Add Testing ~ Deaths
#######################################
### Move Testing into spearate data frame to merge with death model. Testing has a different number of row.
### merge() will correct this magically. The Date column is important, it is a reference column to knit the frames together
temp_testing_model <- data.frame(
date=ca_testing_df$date,
testing_death_mse=testing_predict_deaths_df$mse,
testing_death_predict=testing_predict_deaths_df$predicted_deaths,
testing_death_offset=testing_predict_deaths_df$offset_index
)
#########################################################
### Trim up testing to same Data length as other models
#########################################################
### Yes, it's ugly but it runs with one command.
### Basically, it's start at the row difference to the nrows in data frame
###############################################################################
nrow(testing_predict_deaths_df)
### Testing to deaths model is very noisy. Can only build from aggregate state numbers have State
### Build testing Model from aggreagte state numbers
testing_predict_deaths_df <- build_rolling_lm_offset(offset_testing_df,"daily_total_deaths",15)
####################################################################
### Death Model: Initialize with Testing and Confirmed/Deaths
####################################################################
death_model_df <- merge(removeCols(ca_testing_df,"daily_total_deaths"),daily_combined_df)
#######################################
### Death Model: Add Testing ~ Deaths
#######################################
### Move Testing into spearate data frame to merge with death model. Testing has a different number of row.
### merge() will correct this magically. The Date column is important, it is a reference column to knit the frames together
temp_testing_model <- data.frame(
date=ca_testing_df$date,
testing_death_mse=testing_predict_deaths_df$mse,
testing_death_predict=testing_predict_deaths_df$predicted_deaths,
testing_death_offset=testing_predict_deaths_df$offset_index
)
{ #//BEGIN Code Chunk #3: Build State Models and Death_frame
print("Processing: Code Chunk#3")
##############################
### Build Statewide Models ###
#############################################################################
### Aggregates expensive county models into statewide California numbers. ###
#############################################################################
## Twice the error with 30 days
#confirm_predict_death_30_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\confirm_~_deaths_30"))
### Confirmed cases predicting outcomes
confirm_predict_death_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\confirm_~_deaths"))
confirm_predict_newdeath_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\confirm_~_newdeaths"))
confirm_predict_hospital_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\confirm_~_hospital"))
confirm_predict_icu_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\confirm_~_icu"))
#### Hospitalization predict outcomes
hospital_predict_icu_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\hospital_~_icu"))
hospital_predict_deaths_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\hospital_~_deaths"))
#### ICU predict death
icu_predict_deaths_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\icu_~_deaths"))
### Correlate offset with MSE. I wonder what else correlates with MSE
cor(confirm_predict_death_model_df$predict_offset,confirm_predict_death_model_df$predict_mse)
### Confirm Predicting New Deaths is a shit model. Error only increases
#confirm_predict_newdeaths_model_df   <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\confirm_~_newdeaths"))
newconfirm_predict_newsdeaths_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\newconfirm_~_newdeaths"))
newconfirm_predict_hospital_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\newconfirm_~_hospital"))
newconfirm_predict_icu_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\newconfirm_~_icu"))
hospital_predict_newdeaths_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\hospital_~_newdeaths"))
icu_predict_newdeaths_model_df <- build_statewide_model_from_counties(paste0(workingDir,"\\models\\icu_~_newdeaths"))
### Testing to deaths model is very noisy. Can only build from aggregate state numbers have State
### Build testing Model from aggreagte state numbers
testing_predict_deaths_df <- build_rolling_lm_offset(offset_testing_df,"daily_total_deaths",15)
#########################################################
### Trim up testing to same Data length as other models
#########################################################
### Yes, it's ugly but it runs with one command.
### Basically, it's start at the row difference to the nrows in data frame
###############################################################################
#testing_predict_deaths_df <- testing_predict_deaths_df[
#  (nrow(testing_predict_deaths_df) - nrow(confirm_predict_death_model_df) + 1):
#    nrow(testing_predict_deaths_df),]
######################################################################
######################################################################
######################################################################
### END Modeling #####################################################
######################################################################
######################################################################
######################################################################
##############################################################
### Build the death model.
### Death model combines actual data points with the models
####################################################################
####################################################################
### Death Model: Initialize with Testing and Confirmed/Deaths
####################################################################
death_model_df <- merge(removeCols(ca_testing_df,"daily_total_deaths"),daily_combined_df)
#######################################
### Death Model: Add Testing ~ Deaths
#######################################
### Move Testing into spearate data frame to merge with death model. Testing has a different number of row.
### merge() will correct this magically. The Date column is important, it is a reference column to knit the frames together
temp_testing_model <- data.frame(
date=ca_testing_df$date,
testing_death_mse=testing_predict_deaths_df$mse,
testing_death_predict=testing_predict_deaths_df$predicted_deaths,
testing_death_offset=testing_predict_deaths_df$offset_index
)
death_model_df <- merge(death_model_df, temp_testing_model)
#######################################
### Death Model: Add Confirmed ~ Deaths
#######################################
death_model_df$confirm_death_mse         <- confirm_predict_death_model_df$predict_mse
death_model_df$confirm_death_mse_rescale <- rescale_mse(confirm_predict_death_model_df$predict_mse,confirm_predict_death_model_df$predict_offset)
death_model_df$confirm_death_predict     <- confirm_predict_death_model_df$prediction
death_model_df$confirm_death_offset      <- confirm_predict_death_model_df$predict_offset
#  death_model_df$confirm_death_intercept   <- confirm_predict_death_model_df$predict_intercept
#  death_model_df$confirm_death_coefficient <- confirm_predict_death_model_df$predict_coefficient
death_model_df$confirm_newdeath_mse      <- confirm_predict_newdeath_model_df$predict_mse
death_model_df$confirm_newdeath_predict  <- confirm_predict_newdeath_model_df$prediction
death_model_df$confirm_newdeath_offset   <- confirm_predict_newdeath_model_df$predict_offset
#######################################
### Death Model: Add Confirm ~ Hospital
#######################################
death_model_df$confirm_hospital_mse         <- confirm_predict_hospital_model_df$predict_mse
death_model_df$confirm_hospital_predict     <- confirm_predict_hospital_model_df$prediction
death_model_df$confirm_hospital_offset      <- confirm_predict_hospital_model_df$predict_offset
#  death_model_df$confirm_hospital_intercept   <- confirm_predict_hospital_model_df$predict_intercept
#  death_model_df$confirm_hospital_coefficient <- confirm_predict_hospital_model_df$predict_coefficient
#######################################
### Death Model: Add confirm ~ icu
#######################################
death_model_df$confirm_icu_mse         <- confirm_predict_icu_model_df$predict_mse
death_model_df$confirm_icu_predict     <- confirm_predict_icu_model_df$prediction
death_model_df$confirm_icu_offset      <- confirm_predict_icu_model_df$predict_offset
#  death_model_df$confirm_icu_intercept   <- confirm_predict_icu_model_df$predict_intercept
#  death_model_df$confirm_icu_coefficient <- confirm_predict_icu_model_df$predict_coefficient
death_model_df$newconfirm_newdeath_mse        <- newconfirm_predict_newsdeaths_model_df$predict_mse
death_model_df$newconfirm_newdeath_prediction <- newconfirm_predict_newsdeaths_model_df$prediction
death_model_df$newconfirm_newdeath_offset     <- newconfirm_predict_newsdeaths_model_df$predict_offset
death_model_df$newconfirm_hospital_mse        <- newconfirm_predict_hospital_model_df$predict_mse
death_model_df$newconfirm_hospital_prediction <- newconfirm_predict_hospital_model_df $prediction
death_model_df$newconfirm_hospital_offset     <- newconfirm_predict_hospital_model_df$predict_offset
death_model_df$newconfirm_icu_mse        <- newconfirm_predict_icu_model_df$predict_mse
death_model_df$newconfirm_icu_prediction <- newconfirm_predict_icu_model_df$prediction
death_model_df$newconfirm_icu_offset     <- newconfirm_predict_icu_model_df$predict_offset
#######################################
### Death Model: Add hospital ~ icu
#######################################
death_model_df$hospital_icu_mse         <- hospital_predict_icu_model_df$predict_mse
death_model_df$hospital_icu_predict     <- hospital_predict_icu_model_df$prediction
death_model_df$hospital_icu_offset      <- hospital_predict_icu_model_df$predict_offset
#  death_model_df$hospital_icu_intercept   <- hospital_predict_icu_model_df$predict_intercept
#  death_model_df$hospital_icu_coefficient <- hospital_predict_icu_model_df$predict_coefficient
#######################################
### Death Model: Add hospital ~ death
#######################################
death_model_df$hospital_death_mse         <- hospital_predict_deaths_df$predict_mse
death_model_df$hospital_death_predict     <- hospital_predict_deaths_df$prediction
death_model_df$hospital_death_offset      <- hospital_predict_deaths_df$predict_offset
#  death_model_df$hospital_death_intercept   <- hospital_predict_deaths_df$predict_intercept
#  death_model_df$hospital_death_coefficient <- hospital_predict_deaths_df$predict_coefficient
death_model_df$hospital_newdeath_mse        <- hospital_predict_newdeaths_model_df$predict_mse
death_model_df$hospital_newdeath_prediction <- hospital_predict_newdeaths_model_df$prediction
death_model_df$hospital_newdeath_offset     <- hospital_predict_newdeaths_model_df$predict_offset
#######################################
### Death Model: Add icu ~ death
#######################################
death_model_df$icu_death_mse         <- icu_predict_deaths_df$predict_mse
death_model_df$icu_death_prediction  <- icu_predict_deaths_df$prediction
death_model_df$icu_death_offset      <- icu_predict_deaths_df$predict_offset
#  death_model_df$icu_death_intercept   <- icu_predict_deaths_df$predict_intercept
#  death_model_df$icu_death_coefficient <- icu_predict_deaths_df$predict_coefficient
death_model_df$icu_newdeaths_mse        <- icu_predict_newdeaths_model_df$predict_mse
death_model_df$icu_newdeaths_prediction <- icu_predict_newdeaths_model_df$prediction
death_model_df$icu_newdeaths_offset     <- icu_predict_newdeaths_model_df$predict_offset
#### Build a separate Death Model Comprising the last 30 days
death_model_last_30_df <- death_model_df[ (nrow(death_model_df)-30) : nrow(death_model_df),]
#### Build Post May Death Model
death_model_post_may_df <- death_model_df[ 36 : nrow(death_model_df),]
#### Write Data Frames to File.
#### The Project is to cumbersome to include in an RMD
saveRDS(death_model_df, "model_death_model_df.dat")
saveRDS(death_model_last_30_df, "model_death_model_last_30_df")
saveRDS(death_model_post_may_df, "model_death_model_post_may_df")
print("DONE: Code Chunk#2")
}#//END Code Chunk #3: Build State Models and Death_frame
temp_model <- readRDS("model_death_model_df.dat")
readRDS("model_death_model_df.dat")
readRDS("model_death_model_last_30_df")
